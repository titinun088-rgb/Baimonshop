import { useState, useEffect } from "react";
import Layout from "@/components/Layout";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { 
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { 
  History, 
  CheckCircle, 
  XCircle, 
  Clock, 
  ShoppingCart, 
  RefreshCw,
  Search,
  Filter,
  Info,
  AlertTriangle,
  Calendar,
  CreditCard,
  Package
} from "lucide-react";
import ProductDetailsDialog from "@/components/ProductDetailsDialog";
import { useAuth } from "@/contexts/AuthContext";
import { getPeamsubPurchaseHistory, getPeamsubGameHistory, getPeamsubCashCardHistory, getPeamsubMobileHistory, PeamsubPurchaseHistory, PeamsubGameHistory, PeamsubCashCardHistory, PeamsubMobileHistory, ClaimRequest, ClaimStatus } from "@/lib/peamsubUtils";
import { toast } from "sonner";
import { useNavigate } from "react-router-dom";
import { syncPurchaseHistoryFromAPI, getUserPurchaseHistory, convertFirestoreToAPI, addUserPurchaseReference, getUserPurchaseReferences, FirestorePurchaseHistory } from "@/lib/purchaseHistoryUtils";

const PurchaseHistory = () => {
  const { user, userData } = useAuth();
  const navigate = useNavigate();
  const [purchaseHistory, setPurchaseHistory] = useState<PeamsubPurchaseHistory[]>([]);
  const [gameHistory, setGameHistory] = useState<PeamsubGameHistory[]>([]);
  const [cardHistory, setCardHistory] = useState<PeamsubCashCardHistory[]>([]);
  const [mobileHistory, setMobileHistory] = useState<PeamsubMobileHistory[]>([]);
  const [filteredHistory, setFilteredHistory] = useState<(PeamsubPurchaseHistory | PeamsubGameHistory | PeamsubCashCardHistory | PeamsubMobileHistory)[]>([]);
  const [loading, setLoading] = useState(true);
  const [searchTerm, setSearchTerm] = useState("");
  const [statusFilter, setStatusFilter] = useState("all");
  const [typeFilter, setTypeFilter] = useState("all"); // ‡πÄ‡∏û‡∏¥‡πà‡∏° filter ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
  const [currentPage, setCurrentPage] = useState(1);
  const [itemsPerPage] = useState(10);
  const [selectedItem, setSelectedItem] = useState<PeamsubPurchaseHistory | null>(null);
  const [detailsDialogOpen, setDetailsDialogOpen] = useState(false);

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
  const isAdmin = userData?.role === 'admin';

  useEffect(() => {
    loadPurchaseHistory();
  }, [user]);

  useEffect(() => {
    filterHistory();
  }, [purchaseHistory, gameHistory, cardHistory, mobileHistory, searchTerm, statusFilter, typeFilter]);

  const loadPurchaseHistory = async () => {
    if (!user || !userData) return;

    setLoading(true);
    try {
      const userId = user.uid;
      
      // ‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å Firestore ‡∏Å‡πà‡∏≠‡∏ô (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏°‡∏µ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)
      const firestoreHistory = await getUserPurchaseHistory(userId);
      
      console.log('üìä ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å Firestore:', firestoreHistory.length, '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
      
      // ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏° type ‡πÅ‡∏•‡∏∞‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô API format ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö state ‡πÄ‡∏î‡∏¥‡∏°
      const premiumHistory: PeamsubPurchaseHistory[] = [];
      const gameHistoryData: PeamsubGameHistory[] = [];
      const mobileHistoryData: PeamsubMobileHistory[] = [];
      const cardHistoryData: PeamsubCashCardHistory[] = [];
      
      firestoreHistory.forEach(history => {
        const converted = convertFirestoreToAPI(history);
        
        // ‡πÄ‡∏û‡∏¥‡πà‡∏° sellPrice ‡∏•‡∏á‡πÉ‡∏ô converted object
        if (history.type === 'premium') {
          (converted as any).sellPrice = history.sellPrice;
          premiumHistory.push(converted as PeamsubPurchaseHistory);
        } else if (history.type === 'game') {
          (converted as any).sellPrice = history.sellPrice;
          gameHistoryData.push(converted as PeamsubGameHistory);
        } else if (history.type === 'mobile') {
          (converted as any).sellPrice = history.sellPrice;
          mobileHistoryData.push(converted as PeamsubMobileHistory);
        } else if (history.type === 'cashcard') {
          (converted as any).sellPrice = history.sellPrice;
          cardHistoryData.push(converted as PeamsubCashCardHistory);
        }
      });
      
      // ‡∏î‡∏∂‡∏á references ‡πÄ‡∏û‡∏∑‡πà‡∏≠ sync ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å API (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
      const [premiumRefs, gameRefs, mobileRefs, cashCardRefs] = await Promise.all([
        getUserPurchaseReferences(userId, 'premium'),
        getUserPurchaseReferences(userId, 'game'),
        getUserPurchaseReferences(userId, 'mobile'),
        getUserPurchaseReferences(userId, 'cashcard')
      ]);
      
      // Sync ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å API (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)
      try {
        const [premiumHistoryAPI, gameHistoryAPI, mobileHistoryAPI, cardHistoryAPI] = await Promise.all([
          getPeamsubPurchaseHistory(premiumRefs.length > 0 ? premiumRefs : []).catch(() => []),
          getPeamsubGameHistory(gameRefs.length > 0 ? gameRefs : []).catch(() => []),
          getPeamsubMobileHistory(mobileRefs.length > 0 ? mobileRefs : []).catch(() => []),
          getPeamsubCashCardHistory(cashCardRefs.length > 0 ? cashCardRefs : []).catch(() => [])
        ]);
        
        // Sync ‡∏•‡∏á Firestore (‡∏à‡∏∞‡∏£‡∏±‡∏Å‡∏©‡∏≤ sellPrice ‡πÑ‡∏ß‡πâ)
        await Promise.all([
          syncPurchaseHistoryFromAPI(userId, 'premium', premiumHistoryAPI),
          syncPurchaseHistoryFromAPI(userId, 'game', gameHistoryAPI),
          syncPurchaseHistoryFromAPI(userId, 'mobile', mobileHistoryAPI),
          syncPurchaseHistoryFromAPI(userId, 'cashcard', cardHistoryAPI)
        ]);
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï state ‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firestore ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡∏´‡∏•‡∏±‡∏á sync)
        const updatedHistory = await getUserPurchaseHistory(userId);
        const updatedPremium: PeamsubPurchaseHistory[] = [];
        const updatedGame: PeamsubGameHistory[] = [];
        const updatedMobile: PeamsubMobileHistory[] = [];
        const updatedCard: PeamsubCashCardHistory[] = [];
        
        updatedHistory.forEach(history => {
          const converted = convertFirestoreToAPI(history);
          if (history.type === 'premium') {
            (converted as any).sellPrice = history.sellPrice;
            updatedPremium.push(converted as PeamsubPurchaseHistory);
          } else if (history.type === 'game') {
            (converted as any).sellPrice = history.sellPrice;
            updatedGame.push(converted as PeamsubGameHistory);
          } else if (history.type === 'mobile') {
            (converted as any).sellPrice = history.sellPrice;
            updatedMobile.push(converted as PeamsubMobileHistory);
          } else if (history.type === 'cashcard') {
            (converted as any).sellPrice = history.sellPrice;
            updatedCard.push(converted as PeamsubCashCardHistory);
          }
        });
        
        setPurchaseHistory(updatedPremium);
        setGameHistory(updatedGame);
        setMobileHistory(updatedMobile);
        setCardHistory(updatedCard);
      } catch (error) {
        console.warn('‚ö†Ô∏è ‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á sync ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:', error);
        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firestore ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
        setPurchaseHistory(premiumHistory);
        setGameHistory(gameHistoryData);
        setMobileHistory(mobileHistoryData);
        setCardHistory(cardHistoryData);
      }
    } catch (error) {
      console.error("Error loading purchase history:", error);
      toast.error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏î‡πâ");
    } finally {
      setLoading(false);
    }
  };

  const filterHistory = () => {
    // ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏µ‡πà‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (‡πÅ‡∏≠‡∏û‡∏û‡∏£‡∏µ‡πÄ‡∏°‡∏µ‡∏¢‡∏°, ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏Å‡∏°, ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏ô‡πá‡∏ï-‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠, ‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î)
    const allHistory = [
      ...purchaseHistory.map(item => ({ ...item, type: 'premium' as const })),
      ...gameHistory.map(item => ({ ...item, type: 'game' as const })),
      ...mobileHistory.map(item => ({ ...item, type: 'mobile' as const })),
      ...cardHistory.map(item => ({ ...item, type: 'cashcard' as const }))
    ];
    
    let filtered = [...allHistory];

    // Filter by type
    if (typeFilter !== "all") {
      filtered = filtered.filter(item => item.type === typeFilter);
    }

    // Filter by search term
    if (searchTerm) {
      filtered = filtered.filter(item => {
        const productName = 'productName' in item ? item.productName : item.info;
        const reference = 'refId' in item ? item.refId : item.reference;
        
        return productName?.toLowerCase().includes(searchTerm.toLowerCase()) ||
               reference?.toLowerCase().includes(searchTerm.toLowerCase());
      });
    }

    // Filter by status
    if (statusFilter !== "all") {
      filtered = filtered.filter(item => {
        switch (statusFilter) {
          case "success":
            return item.status === "success" || item.status === "completed";
          case "pending":
            return item.status === "pending" || item.status === "processing";
          case "failed":
            return item.status === "failed" || item.status === "error";
          default:
            return true;
        }
      });
    }

    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà‡∏™‡∏∏‡∏î‡πÑ‡∏õ‡πÄ‡∏Å‡πà‡∏≤‡∏™‡∏∏‡∏î
    filtered = filtered.sort((a, b) => {
      const dateA = new Date(a.createdAt || a.date || 0).getTime();
      const dateB = new Date(b.createdAt || b.date || 0).getTime();
      return dateB - dateA; // ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô
    });

    setFilteredHistory(filtered);
    setCurrentPage(1); // Reset to first page when filtering
  };

  const getStatusBadge = (status: string) => {
    switch (status?.toLowerCase()) {
      case "success":
      case "completed":
        return <Badge className="bg-green-100 text-green-800 border-green-200">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</Badge>;
      case "pending":
      case "processing":
        return <Badge className="bg-yellow-100 text-yellow-800 border-yellow-200">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</Badge>;
      case "failed":
      case "error":
        return <Badge className="bg-red-100 text-red-800 border-red-200">‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</Badge>;
      default:
        return <Badge className="bg-gray-100 text-gray-800 border-gray-200">{status || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö"}</Badge>;
    }
  };

  const formatDate = (dateString: string) => {
    try {
      const date = new Date(dateString);
      return date.toLocaleDateString('th-TH', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    } catch {
      return dateString;
    }
  };

  const formatAmount = (amount: string | number) => {
    const numAmount = typeof amount === 'string' ? parseFloat(amount) : amount;
    return isNaN(numAmount) ? '0.00' : numAmount.toFixed(2);
  };

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤ - ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå
  const getDisplayPrice = (item: PeamsubPurchaseHistory | PeamsubGameHistory | PeamsubCashCardHistory | PeamsubMobileHistory) => {
    // ‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå (sellPrice) ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ, ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏à‡∏≤‡∏Å API
    const sellPrice = (item as any).sellPrice;
    const apiPrice = getItemPrice(item);
    
    const finalPrice = sellPrice && sellPrice > 0 ? sellPrice : apiPrice;
    
    return {
      price: formatAmount(finalPrice),
      label: "‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå",
      color: "text-green-600"
    };
  };

  const getItemPrice = (item: PeamsubPurchaseHistory | PeamsubGameHistory | PeamsubCashCardHistory | PeamsubMobileHistory) => {
    return 'price' in item ? item.price : item.price;
  };

  const getItemName = (item: PeamsubPurchaseHistory | PeamsubGameHistory | PeamsubCashCardHistory | PeamsubMobileHistory) => {
    return 'productName' in item ? item.productName : item.info;
  };

  const getItemReference = (item: PeamsubPurchaseHistory | PeamsubGameHistory | PeamsubCashCardHistory | PeamsubMobileHistory) => {
    return 'refId' in item ? item.refId : item.reference;
  };

  const handleClaimProduct = async (item: PeamsubPurchaseHistory) => {
    try {
      // TODO: Implement claim product functionality with proper UI
      // For now, show a placeholder message
      toast.info("‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡πÄ‡∏Ñ‡∏•‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ");
      
      // Example of how to use the new claim API:
      // const claimRequest: ClaimRequest = {
      //   reference: item.refId,
      //   status: 'wrong_password' as ClaimStatus,
      //   description: '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
      //   callbackUrl: 'https://your-domain.com/api/claim-callback'
      // };
      // const result = await claimPeamsubProduct(claimRequest);
      // toast.success(`‡πÄ‡∏Ñ‡∏•‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à Ticket ID: ${result.ticketId}`);
    } catch (error) {
      console.error("Error claiming product:", error);
      toast.error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ñ‡∏•‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ");
    }
  };

  const handleViewDetails = (item: PeamsubPurchaseHistory) => {
    setSelectedItem(item);
    setDetailsDialogOpen(true);
  };

  // Pagination
  const totalPages = Math.ceil(filteredHistory.length / itemsPerPage);
  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = startIndex + itemsPerPage;
  const currentItems = filteredHistory.slice(startIndex, endIndex);

  const goToPage = (page: number) => {
    if (page >= 1 && page <= totalPages) {
      setCurrentPage(page);
    }
  };

  const stats = {
    totalPurchases: purchaseHistory.length + gameHistory.length + mobileHistory.length + cardHistory.length,
    successfulPurchases: [...purchaseHistory, ...gameHistory, ...mobileHistory, ...cardHistory].filter(item => 
      item.status === "success" || item.status === "completed"
    ).length,
    pendingPurchases: [...purchaseHistory, ...gameHistory, ...mobileHistory, ...cardHistory].filter(item => 
      item.status === "pending" || item.status === "processing"
    ).length,
    failedPurchases: [...purchaseHistory, ...gameHistory, ...mobileHistory, ...cardHistory].filter(item => 
      item.status === "failed" || item.status === "error"
    ).length,
    totalAmount: [...purchaseHistory, ...gameHistory, ...mobileHistory, ...cardHistory].reduce((sum, item) => {
      // ‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå (sellPrice) ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
      const sellPrice = (item as any).sellPrice;
      const apiPrice = typeof item.price === 'string' ? parseFloat(item.price) : item.price;
      const amount = sellPrice && sellPrice > 0 ? sellPrice : apiPrice;
      return sum + (isNaN(amount) ? 0 : amount);
    }, 0)
  };

  if (loading) {
    return (
      <Layout>
        <div className="flex items-center justify-center min-h-[400px]">
          <div className="text-center">
            <RefreshCw className="h-8 w-8 animate-spin mx-auto mb-4 text-primary" />
            <p className="text-muted-foreground">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠...</p>
          </div>
        </div>
      </Layout>
    );
  }

  return (
    <Layout>
      <div className="space-y-6">
        {/* Header */}
        <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
          <div>
            <h1 className="text-2xl sm:text-3xl font-bold text-primary">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h1>
            <p className="text-muted-foreground mt-1 sm:mt-2 text-sm sm:text-base">
              ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
            </p>
          </div>
          <Button onClick={loadPurchaseHistory} disabled={loading} size="sm" className="w-full sm:w-auto">
            <RefreshCw className={`h-4 w-4 mr-2 ${loading ? 'animate-spin' : ''}`} />
            ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
          </Button>
        </div>

        {/* Stats Cards */}
        <div className="grid grid-cols-2 lg:grid-cols-4 gap-2 sm:gap-4">
          <Card>
            <CardContent className="p-6">
              <div className="flex items-center">
                <ShoppingCart className="h-8 w-8 text-blue-600" />
                <div className="ml-4">
                  <p className="text-sm font-medium text-muted-foreground">‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                  <p className="text-2xl font-bold">{stats.totalPurchases}</p>
                </div>
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-6">
              <div className="flex items-center">
                <CheckCircle className="h-8 w-8 text-green-600" />
                <div className="ml-4">
                  <p className="text-sm font-medium text-muted-foreground">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p>
                  <p className="text-2xl font-bold text-green-600">{stats.successfulPurchases}</p>
                </div>
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-6">
              <div className="flex items-center">
                <Clock className="h-8 w-8 text-yellow-600" />
                <div className="ml-4">
                  <p className="text-sm font-medium text-muted-foreground">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</p>
                  <p className="text-2xl font-bold text-yellow-600">{stats.pendingPurchases}</p>
                </div>
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-6">
              <div className="flex items-center">
                <CreditCard className="h-8 w-8 text-purple-600" />
                <div className="ml-4">
                  <p className="text-sm font-medium text-muted-foreground">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</p>
                  <p className="text-2xl font-bold text-purple-600">{formatAmount(stats.totalAmount)} ‡∏ö‡∏≤‡∏ó</p>
                </div>
              </div>
            </CardContent>
          </Card>
        </div>

        {/* Filters and Search */}
        <Card>
          <CardContent className="p-6">
            <div className="flex flex-col md:flex-row gap-4">
              <div className="flex-1">
                <div className="relative">
                  <Search className="absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground" />
                  <Input
                    placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á..."
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    className="pl-10"
                  />
                </div>
              </div>
              <div className="w-full md:w-48">
                <Select value={statusFilter} onValueChange={setStatusFilter}>
                  <SelectTrigger>
                    <SelectValue placeholder="‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="all">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</SelectItem>
                    <SelectItem value="success">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</SelectItem>
                    <SelectItem value="pending">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</SelectItem>
                    <SelectItem value="failed">‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</SelectItem>
                  </SelectContent>
                </Select>
              </div>
              <div className="w-full md:w-48">
                <Select value={typeFilter} onValueChange={setTypeFilter}>
                  <SelectTrigger>
                    <SelectValue placeholder="‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="all">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</SelectItem>
                    <SelectItem value="premium">‡πÅ‡∏≠‡∏û‡∏û‡∏£‡∏µ‡πÄ‡∏°‡∏µ‡∏¢‡∏°</SelectItem>
                    <SelectItem value="game">‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏Å‡∏°</SelectItem>
                    <SelectItem value="mobile">‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏ô‡πá‡∏ï-‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠</SelectItem>
                    <SelectItem value="cashcard">‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</SelectItem>
                  </SelectContent>
                </Select>
              </div>
            </div>
          </CardContent>
        </Card>

        {/* Purchase History - Mobile Card View / Desktop Table */}
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2 text-lg sm:text-xl">
              <History className="h-4 w-4 sm:h-5 sm:w-5" />
              ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
            </CardTitle>
            <CardDescription className="text-xs sm:text-sm">
              ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà {startIndex + 1} ‡∏ñ‡∏∂‡∏á {Math.min(endIndex, filteredHistory.length)} ‡∏à‡∏≤‡∏Å {filteredHistory.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
            </CardDescription>
          </CardHeader>
          <CardContent>
            {currentItems.length === 0 ? (
              <div className="text-center py-8">
                <Package className="h-12 w-12 mx-auto text-muted-foreground mb-4" />
                <p className="text-muted-foreground">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p>
              </div>
            ) : (
              <>
                {/* Mobile Card View */}
                <div className="block md:hidden space-y-3">
                  {currentItems.map((item, index) => (
                    <Card key={item.id || index} className="p-4">
                      <div className="space-y-3">
                        <div className="flex items-start justify-between">
                          <div className="flex-1">
                            <p className="font-semibold text-sm mb-1">{getItemName(item)}</p>
                            <div className="flex items-center gap-2 text-xs text-muted-foreground">
                              <Calendar className="h-3 w-3" />
                              {formatDate(item.createdAt || item.date || new Date().toISOString())}
                            </div>
                          </div>
                          <Badge variant={
                            item.type === 'premium' ? 'default' : 
                            item.type === 'game' ? 'secondary' : 
                            item.type === 'mobile' ? 'destructive' :
                            'outline'
                          } className="text-xs">
                            {item.type === 'premium' ? '‡πÅ‡∏≠‡∏û‡∏û‡∏£‡∏µ‡πÄ‡∏°‡∏µ‡∏¢‡∏°' : 
                             item.type === 'game' ? '‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏Å‡∏°' : 
                             item.type === 'mobile' ? '‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏ô‡πá‡∏ï' :
                             '‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î'}
                          </Badge>
                        </div>
                        <div className="flex items-center justify-between pt-2 border-t">
                          <div>
                            <p className="text-xs text-muted-foreground">‡∏£‡∏≤‡∏Ñ‡∏≤</p>
                            <p className={`font-semibold ${getDisplayPrice(item).color}`}>
                              {getDisplayPrice(item).price} ‡∏ö‡∏≤‡∏ó
                            </p>
                          </div>
                          <div className="text-right">
                            <p className="text-xs text-muted-foreground">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</p>
                            {getStatusBadge(item.status)}
                          </div>
                        </div>
                        <div className="flex gap-2 pt-2">
                          <Button
                            variant="outline"
                            size="sm"
                            className="flex-1 text-xs"
                            onClick={() => handleViewDetails(item)}
                          >
                            <Info className="h-3 w-3 mr-1" />
                            ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                          </Button>
                          <Button
                            variant="outline"
                            size="sm"
                            className="flex-1 text-xs"
                            onClick={() => handleClaimProduct(item)}
                            disabled={item.status !== "success" && item.status !== "completed"}
                          >
                            <AlertTriangle className="h-3 w-3 mr-1" />
                            ‡πÄ‡∏Ñ‡∏•‡∏°
                          </Button>
                        </div>
                      </div>
                    </Card>
                  ))}
                </div>

                {/* Desktop Table View */}
                <div className="hidden md:block overflow-x-auto">
                  <table className="w-full">
                    <thead>
                      <tr className="border-b">
                        <th className="text-left p-3 font-medium text-sm">#</th>
                        <th className="text-left p-3 font-medium text-sm">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                        <th className="text-left p-3 font-medium text-sm">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                        <th className="text-left p-3 font-medium text-sm">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                        <th className="text-left p-3 font-medium text-sm">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                        <th className="text-left p-3 font-medium text-sm">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                        <th className="text-left p-3 font-medium text-sm">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
                        <th className="text-left p-3 font-medium text-sm">‡πÄ‡∏Ñ‡∏•‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                      </tr>
                    </thead>
                    <tbody>
                      {currentItems.map((item, index) => (
                        <tr key={item.id || index} className="border-b hover:bg-muted/50">
                          <td className="p-3 text-sm">{startIndex + index + 1}</td>
                          <td className="p-3 text-sm">
                            <div className="flex items-center gap-2">
                              <Calendar className="h-4 w-4 text-muted-foreground" />
                              {formatDate(item.createdAt || item.date || new Date().toISOString())}
                            </div>
                          </td>
                          <td className="p-3">
                            <Badge variant={
                              item.type === 'premium' ? 'default' : 
                              item.type === 'game' ? 'secondary' : 
                              item.type === 'mobile' ? 'destructive' :
                              'outline'
                            } className="text-xs">
                              {item.type === 'premium' ? '‡πÅ‡∏≠‡∏û‡∏û‡∏£‡∏µ‡πÄ‡∏°‡∏µ‡∏¢‡∏°' : 
                               item.type === 'game' ? '‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏Å‡∏°' : 
                               item.type === 'mobile' ? '‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏ô‡πá‡∏ï-‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠' :
                               '‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î'}
                            </Badge>
                          </td>
                          <td className="p-3 font-medium text-sm">{getItemName(item)}</td>
                          <td className="p-3 text-sm">
                            <div className="flex flex-col">
                              <span className={`font-semibold ${getDisplayPrice(item).color}`}>
                                {getDisplayPrice(item).price} ‡∏ö‡∏≤‡∏ó
                              </span>
                              <span className="text-xs text-gray-500">
                                {getDisplayPrice(item).label}
                              </span>
                            </div>
                          </td>
                          <td className="p-3">{getStatusBadge(item.status)}</td>
                          <td className="p-3">
                            <Button
                              variant="outline"
                              size="sm"
                              onClick={() => handleViewDetails(item)}
                            >
                              <Info className="h-4 w-4" />
                            </Button>
                          </td>
                          <td className="p-3">
                            <Button
                              variant="outline"
                              size="sm"
                              onClick={() => handleClaimProduct(item)}
                              disabled={item.status !== "success" && item.status !== "completed"}
                            >
                              <AlertTriangle className="h-4 w-4" />
                            </Button>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </>
            )}

            {/* Pagination */}
            {totalPages > 1 && (
              <div className="flex flex-col sm:flex-row items-center justify-between gap-4 mt-6">
                <div className="text-xs sm:text-sm text-muted-foreground text-center sm:text-left">
                  ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà {startIndex + 1} ‡∏ñ‡∏∂‡∏á {Math.min(endIndex, filteredHistory.length)} ‡∏à‡∏≤‡∏Å {filteredHistory.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                </div>
                <div className="flex items-center gap-1 sm:gap-2 w-full sm:w-auto justify-center">
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() => goToPage(currentPage - 1)}
                    disabled={currentPage === 1}
                    className="text-xs"
                  >
                    ‚Üê
                  </Button>
                  
                  {/* Mobile: Show less pages */}
                  <div className="hidden sm:flex items-center gap-2">
                    {Array.from({ length: Math.min(5, totalPages) }, (_, i) => {
                      const pageNum = Math.max(1, Math.min(totalPages - 4, currentPage - 2)) + i;
                      if (pageNum > totalPages) return null;
                      
                      return (
                        <Button
                          key={pageNum}
                          variant={currentPage === pageNum ? "default" : "outline"}
                          size="sm"
                          onClick={() => goToPage(pageNum)}
                          className="text-xs"
                        >
                          {pageNum}
                        </Button>
                      );
                    })}
                  </div>
                  
                  {/* Mobile: Show current page only */}
                  <div className="flex sm:hidden items-center gap-1">
                    <Button
                      variant="default"
                      size="sm"
                      className="text-xs"
                      disabled
                    >
                      {currentPage} / {totalPages}
                    </Button>
                  </div>
                  
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() => goToPage(currentPage + 1)}
                    disabled={currentPage === totalPages}
                    className="text-xs"
                  >
                    ‚Üí
                  </Button>
                  
                  {/* Desktop: Page input */}
                  <div className="hidden lg:flex items-center gap-2 ml-2">
                    <span className="text-xs text-muted-foreground">‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤:</span>
                    <Input
                      type="number"
                      min="1"
                      max={totalPages}
                      value={currentPage}
                      onChange={(e) => {
                        const page = parseInt(e.target.value);
                        if (page >= 1 && page <= totalPages) {
                          goToPage(page);
                        }
                      }}
                      className="w-16 h-8 text-xs"
                    />
                  </div>
                </div>
              </div>
            )}
          </CardContent>
        </Card>
      </div>

      {/* Product Details Dialog */}
      <ProductDetailsDialog
        isOpen={detailsDialogOpen}
        onClose={() => {
          setDetailsDialogOpen(false);
          setSelectedItem(null);
        }}
        purchaseItem={selectedItem}
      />
    </Layout>
  );
};

export default PurchaseHistory;
