# 🔔 ระบบแจ้งเตือน & รายงานปัญหา (Notification & Report System)

## ✅ สิ่งที่สร้างเสร็จแล้ว

ระบบแจ้งเตือนและรายงานปัญหาสมบูรณ์ พร้อมใช้งาน! 🎉

### **ฟีเจอร์หลัก:**

1. ✅ **ระบบแจ้งเตือน (Notifications)**
   - Admin สร้างประกาศ/แจ้งเตือน
   - กำหนดเป้าหมาย: ทั้งระบบ หรือ เฉพาะคน
   - โหมดการแสดง: แสดงครั้งเดียว หรือ ทุกครั้ง
   - แสดงเป็น Banner/Popup มุมบนขวา
   - เปิด/ปิดการแสดงผลได้

2. ✅ **ระบบรายงานปัญหา (Reports)**
   - ผู้ใช้สามารถแจ้งปัญหาได้
   - กำหนดความสำคัญและหมวดหมู่
   - Admin ดูและจัดการรายงานทั้งหมด
   - อัปเดตสถานะ (รอดำเนินการ, กำลังดำเนินการ, แก้ไขแล้ว, ปฏิเสธ)
   - เพิ่มบันทึกจาก Admin

3. ✅ **NotificationBanner Component**
   - แสดงอัตโนมัติเมื่อมีประกาศใหม่
   - Dismiss ได้
   - สีสันตามประเภท (info, success, warning, error)
   - Refresh ทุก 5 นาที

4. ✅ **Admin Features**
   - สร้างประกาศ/แจ้งเตือน
   - จัดการรายงานปัญหาทั้งหมด
   - อัปเดตสถานะรายงาน
   - เพิ่มบันทึกให้ผู้แจ้ง

---

## 📊 โครงสร้างข้อมูล

### **1. Notification (แจ้งเตือน)**

```typescript
interface Notification {
  id: string;
  title: string;                           // หัวข้อ
  message: string;                          // ข้อความ
  type: "info" | "success" | "warning" | "error"; // ประเภท
  showMode: "once" | "always";              // โหมดการแสดง
  targetType: "all" | "specific";          // เป้าหมาย
  targetUserId?: string;                    // ID ผู้ใช้เฉพาะ (ถ้า specific)
  targetUserEmail?: string;                 // อีเมลผู้ใช้เฉพาะ
  readBy: string[];                         // Array ของ userId ที่อ่านแล้ว
  active: boolean;                          // เปิด/ปิดการแสดงผล
  createdBy: string;                        // UID ของ Admin ที่สร้าง
  createdAt: Date;                          // วันที่สร้าง
  updatedAt?: Date;                         // วันที่อัปเดต
}
```

**โครงสร้าง Firestore:**
```
notifications/
├─ {notificationId}/
│  ├─ title: "แจ้งปิดปรับปรุงระบบ"
│  ├─ message: "ระบบจะปิดปรับปรุงวันที่ 20 ต.ค. 2567"
│  ├─ type: "warning"
│  ├─ showMode: "always"
│  ├─ targetType: "all"
│  ├─ targetUserId: null
│  ├─ targetUserEmail: null
│  ├─ readBy: []
│  ├─ active: true
│  ├─ createdBy: "admin-uid"
│  ├─ createdAt: Timestamp
│  └─ updatedAt: Timestamp
```

---

### **2. Report (รายงานปัญหา)**

```typescript
interface Report {
  id: string;
  userId: string;                          // UID ของผู้แจ้ง
  userEmail: string;                       // อีเมลผู้แจ้ง
  shopName?: string;                       // ชื่อร้าน
  title: string;                           // หัวข้อปัญหา
  description: string;                     // รายละเอียด
  status: "pending" | "in-progress" | "resolved" | "rejected"; // สถานะ
  priority: "low" | "medium" | "high";    // ความสำคัญ
  category: string;                        // หมวดหมู่
  adminNote?: string;                      // บันทึกจาก Admin
  resolvedBy?: string;                     // UID ของ Admin ที่แก้ไข
  createdAt: Date;                         // วันที่แจ้ง
  updatedAt?: Date;                        // วันที่อัปเดต
  resolvedAt?: Date;                       // วันที่แก้ไขเสร็จ
}
```

**โครงสร้าง Firestore:**
```
reports/
├─ {reportId}/
│  ├─ userId: "user-uid"
│  ├─ userEmail: "user@example.com"
│  ├─ shopName: "ร้านเกมดี"
│  ├─ title: "ไม่สามารถเข้าสู่ระบบได้"
│  ├─ description: "หลังจากกรอกอีเมลและรหัสผ่าน..."
│  ├─ status: "pending"
│  ├─ priority: "high"
│  ├─ category: "technical"
│  ├─ adminNote: "กำลังตรวจสอบปัญหา"
│  ├─ resolvedBy: null
│  ├─ createdAt: Timestamp
│  ├─ updatedAt: Timestamp
│  └─ resolvedAt: null
```

---

## 🔧 การทำงาน

### **1. ระบบแจ้งเตือน (Notifications)**

#### **สร้างประกาศ (Admin)**

```
1. ไปที่หน้า "แจ้งเตือน" (/notifications)
2. คลิก "สร้างประกาศ"
3. กรอกฟอร์ม:
   ├─ ประเภท: info, success, warning, error
   ├─ หัวข้อ: "แจ้งปิดปรับปรุงระบบ"
   ├─ ข้อความ: "ระบบจะปิดปรับปรุง..."
   ├─ เป้าหมาย: ทั้งระบบ หรือ เฉพาะคน
   ├─ โหมดการแสดง: ครั้งเดียว หรือ ทุกครั้ง
   └─ (ถ้าเฉพาะคน) เลือกผู้ใช้
4. ดู Preview
5. คลิก "สร้างแจ้งเตือน"
6. ✅ สำเร็จ!
```

#### **โหมดการแสดง:**

**1. แสดงครั้งเดียว (once):**
```
├─ ผู้ใช้เห็นครั้งแรก → แสดง Banner
├─ ผู้ใช้กด X (dismiss) → บันทึก readBy
└─ ครั้งต่อไป → ไม่แสดงอีก
```

**2. แสดงทุกครั้ง (always):**
```
├─ ผู้ใช้เห็นทุกครั้งที่เข้าเว็บ
├─ ผู้ใช้กด X (dismiss) → ซ่อนชั่วคราว
└─ Refresh หรือเข้าใหม่ → แสดงอีก
```

#### **เป้าหมาย:**

**1. ทั้งระบบ (all):**
```
├─ แสดงให้ทุกคนเห็น
├─ Seller, Admin ทุกคนเห็น
└─ ใช้สำหรับประกาศทั่วไป
```

**2. เฉพาะคน (specific):**
```
├─ แสดงเฉพาะผู้ใช้ที่เลือก
├─ คนอื่นไม่เห็น
└─ ใช้สำหรับแจ้งเตือนส่วนตัว
```

#### **ประเภท (Type) และสี:**

```
📘 info      → สีน้ำเงิน (ข้อมูลทั่วไป)
✅ success   → สีเขียว (ข่าวดี)
⚠️ warning   → สีเหลือง (คำเตือน)
❌ error     → สีแดง (ข้อผิดพลาด)
```

#### **ตัวอย่าง:**

```
┌────────────────────────────────────────┐
│ ⚠️ แจ้งปิดปรับปรุงระบบ         [X]   │
│ ระบบจะปิดปรับปรุงวันที่ 20 ต.ค.      │
│ 2567 เวลา 00:00 - 06:00 น.            │
│ 💡 ประกาศนี้จะแสดงทุกครั้งจนกว่าจะ...│
└────────────────────────────────────────┘
```

---

### **2. ระบบรายงานปัญหา (Reports)**

#### **แจ้งปัญหา (ทุกคน)**

```
1. ไปที่หน้า "แจ้งเตือน" (/notifications)
2. คลิก "แจ้งปัญหา" (ปุ่มสีส้ม)
3. กรอกฟอร์ม:
   ├─ หมวดหมู่: ปัญหาทางเทคนิค, บิลลิ่ง, Bug, ฯลฯ
   ├─ หัวข้อ: "ไม่สามารถเข้าสู่ระบบได้"
   ├─ รายละเอียด: อธิบายปัญหาโดยละเอียด
   └─ ความสำคัญ: ต่ำ, ปานกลาง, สูง
4. คลิก "แจ้งปัญหา"
5. ✅ สำเร็จ! ทีมงานจะดำเนินการ
```

#### **จัดการรายงาน (Admin)**

```
1. ไปที่หน้า "รายงานปัญหา" (/reports)
2. ดูรายงานทั้งหมด
3. คลิก "ดูรายละเอียด"
4. อ่านรายงาน
5. อัปเดตสถานะ:
   ├─ รอดำเนินการ
   ├─ กำลังดำเนินการ
   ├─ แก้ไขแล้ว
   └─ ปฏิเสธ
6. เพิ่มบันทึกจาก Admin (ถ้าต้องการ)
7. คลิก "อัปเดตสถานะ"
8. ✅ สำเร็จ!
```

#### **สถานะรายงาน:**

```
🟡 รอดำเนินการ (pending)
   └─ รายงานใหม่ ยังไม่ได้ดำเนินการ

🔵 กำลังดำเนินการ (in-progress)
   └─ Admin กำลังแก้ไขปัญหา

🟢 แก้ไขแล้ว (resolved)
   └─ ปัญหาได้รับการแก้ไขเรียบร้อย

🔴 ปฏิเสธ (rejected)
   └─ ปฏิเสธการดำเนินการ (พร้อมเหตุผล)
```

#### **ความสำคัญ:**

```
🔴 สูง (high)
   └─ ไม่สามารถใช้งานได้เลย ต้องแก้ไขด่วน

🟡 ปานกลาง (medium)
   └─ ใช้งานได้แต่มีปัญหา

🟢 ต่ำ (low)
   └─ ใช้งานได้ปกติ มีข้อเสนอแนะ
```

#### **หมวดหมู่:**

```
🔧 ปัญหาทางเทคนิค (technical)
💰 ปัญหาการเงิน/บิลลิ่ง (billing)
✨ ขอฟีเจอร์ใหม่ (feature)
🐛 พบ Bug/ข้อผิดพลาด (bug)
👤 ปัญหาบัญชีผู้ใช้ (account)
📋 อื่นๆ (other)
```

---

## 🎯 User Experience

### **1. NotificationBanner (มุมบนขวา)**

```
┌──────────────────────────────────────┐
│                            [Website] │
│                                      │
│          ┌─────────────────────┐    │
│          │ 🔔 แจ้งเตือน [X]  │    │ ← Banner แสดงที่นี่
│          │ มีฟีเจอร์ใหม่!      │    │
│          │ ลองใช้ระบบยอดขาย   │    │
│          └─────────────────────┘    │
│                                      │
│  [Dashboard Content]                 │
└──────────────────────────────────────┘
```

### **2. หน้าแจ้งเตือน (/notifications)**

**Seller:**
```
┌────────────────────────────────────────┐
│ แจ้งเตือน                     [แจ้งปัญหา] │
├────────────────────────────────────────┤
│                                        │
│ 🔔 แจ้งปิดปรับปรุงระบบ                │
│ ⚠️ คำเตือน  แสดงทุกครั้ง              │
│ ระบบจะปิดปรับปรุงวันที่ 20 ต.ค....   │
│ 18 ต.ค. 2567, 14:30                   │
│                                        │
│ ✅ ฟีเจอร์ใหม่: ระบบยอดขาย            │
│ ✅ สำเร็จ  ครั้งเดียว                  │
│ ตอนนี้คุณสามารถบันทึกยอดขาย...       │
│ 17 ต.ค. 2567, 10:00                   │
│                                        │
└────────────────────────────────────────┘
```

**Admin:**
```
┌────────────────────────────────────────┐
│ แจ้งเตือน         [แจ้งปัญหา] [สร้างประกาศ] │
├────────────────────────────────────────┤
│                                        │
│ 🔔 แจ้งปิดปรับปรุงระบบ    [🔵ON] [🗑️] │
│ ⚠️ คำเตือน  แสดงทุกครั้ง  ทั้งระบบ    │
│ ระบบจะปิดปรับปรุงวันที่ 20 ต.ค....   │
│ 18 ต.ค. 2567, 14:30  อ่านแล้ว: 25 คน │
│                                        │
│ ✅ ฟีเจอร์ใหม่    [🔴OFF] [🗑️]        │
│ ✅ สำเร็จ  ครั้งเดียว  ปิดอยู่         │
│ ตอนนี้คุณสามารถบันทึกยอดขาย...       │
│ 17 ต.ค. 2567, 10:00  อ่านแล้ว: 50 คน │
│                                        │
└────────────────────────────────────────┘
```

### **3. หน้ารายงานปัญหา (/reports - Admin)**

```
┌────────────────────────────────────────┐
│ รายงานปัญหา                            │
├────────────────────────────────────────┤
│ [รอดำเนินการ: 5] [กำลังดำเนินการ: 3]  │
│ [แก้ไขแล้ว: 12] [ปฏิเสธ: 1] [ทั้งหมด: 21] │
├────────────────────────────────────────┤
│ กรองตามสถานะ: [ทั้งหมด (21) ▼]        │
├────────────────────────────────────────┤
│                                        │
│ ⚠️ ไม่สามารถเข้าสู่ระบบได้            │
│ 🔴 สูง  🟡 รอดำเนินการ  🔧 ปัญหาทางเทคนิค │
│ หลังจากกรอกอีเมลและรหัสผ่าน...       │
│ แจ้งโดย: shop@example.com              │
│ 18 ต.ค. 2567, 15:30    [ดูรายละเอียด] [🗑️] │
│                                        │
│ 🐛 พบ Bug หน้า Dashboard               │
│ 🟡 ปานกลาง  🔵 กำลังดำเนินการ  🐛 Bug │
│ กราฟยอดขายไม่แสดงข้อมูล...            │
│ แจ้งโดย: seller@example.com            │
│ 17 ต.ค. 2567, 10:00  แก้ไขเมื่อ: 18 ต.ค. [ดูรายละเอียด] [🗑️] │
│                                        │
└────────────────────────────────────────┘
```

---

## 🔐 สิทธิ์การเข้าถึง

### **Seller (ร้านทั่วไป):**

**ระบบแจ้งเตือน:**
```
✅ ดูแจ้งเตือนของตัวเอง
✅ ดูแจ้งเตือนทั้งระบบ
✅ แจ้งปัญหา/รายงานปัญหา
❌ ไม่สามารถสร้างประกาศ
❌ ไม่สามารถลบแจ้งเตือน
❌ ไม่สามารถเปิด/ปิดแจ้งเตือน
```

**ระบบรายงานปัญหา:**
```
✅ แจ้งปัญหา
✅ ดูรายงานปัญหาของตัวเอง
✅ เห็นบันทึกจาก Admin
❌ ไม่เห็นรายงานของคนอื่น
❌ ไม่สามารถอัปเดตสถานะ
❌ ไม่สามารถลบรายงาน
```

### **Admin:**

**ระบบแจ้งเตือน:**
```
✅ สร้างประกาศ/แจ้งเตือน
✅ กำหนดเป้าหมาย (ทั้งระบบ/เฉพาะคน)
✅ กำหนดโหมดการแสดง
✅ เปิด/ปิดแจ้งเตือน
✅ ลบแจ้งเตือน
✅ ดูจำนวนผู้อ่าน
✅ ดูแจ้งเตือนทั้งหมด
```

**ระบบรายงานปัญหา:**
```
✅ ดูรายงานปัญหาทั้งหมด
✅ กรองตามสถานะ
✅ อัปเดตสถานะรายงาน
✅ เพิ่มบันทึกให้ผู้แจ้ง
✅ ลบรายงาน
✅ ดูสถิติ (Pending, In-progress, Resolved, Rejected)
```

---

## 📁 ไฟล์ที่สร้าง/แก้ไข

### **1. Types:**
- ✅ `src/types/notification.ts` - Types สำหรับ Notification และ Report

### **2. Utils:**
- ✅ `src/lib/notificationUtils.ts` - CRUD functions สำหรับแจ้งเตือน
- ✅ `src/lib/reportUtils.ts` - CRUD functions สำหรับรายงานปัญหา

### **3. Components:**
- ✅ `src/components/CreateNotificationDialog.tsx` - Dialog สร้างประกาศ (Admin)
- ✅ `src/components/CreateReportDialog.tsx` - Dialog แจ้งปัญหา (ทุกคน)
- ✅ `src/components/NotificationBanner.tsx` - Banner แสดงแจ้งเตือน

### **4. Pages:**
- ✅ `src/pages/Notifications.tsx` - หน้าแจ้งเตือน (สำหรับทุกคน + Admin)
- ✅ `src/pages/Reports.tsx` - หน้ารายงานปัญหา (Admin only)

### **5. Routes & Layout:**
- ✅ `src/App.tsx` - เพิ่ม route `/reports`
- ✅ `src/components/Layout.tsx` - เพิ่มเมนู "รายงานปัญหา" (Admin only) และ NotificationBanner

---

## 🚀 วิธีใช้งาน

### **1. สร้างประกาศ (Admin)**

```
Scenario: แจ้งปิดปรับปรุงระบบ

1. Login เป็น Admin
2. ไปที่ /notifications
3. คลิก "สร้างประกาศ"
4. เลือกประเภท: ⚠️ คำเตือน (warning)
5. หัวข้อ: "แจ้งปิดปรับปรุงระบบ"
6. ข้อความ: "ระบบจะปิดปรับปรุงวันที่ 20 ต.ค. 2567..."
7. เป้าหมาย: ทั้งระบบ
8. โหมด: แสดงทุกครั้ง
9. ดู Preview
10. คลิก "สร้างแจ้งเตือน"
11. ✅ ทุกคนเห็น Banner!
```

### **2. แจ้งปัญหา (ทุกคน)**

```
Scenario: ไม่สามารถเข้าสู่ระบบได้

1. ไปที่ /notifications
2. คลิก "แจ้งปัญหา"
3. หมวดหมู่: ปัญหาทางเทคนิค
4. หัวข้อ: "ไม่สามารถเข้าสู่ระบบได้"
5. รายละเอียด: "หลังจากกรอกอีเมลและรหัสผ่านแล้ว กดเข้าสู่ระบบ หน้าจอค้างไม่ตอบสนอง"
6. ความสำคัญ: สูง
7. คลิก "แจ้งปัญหา"
8. ✅ ส่งรายงานสำเร็จ! Admin จะดำเนินการ
```

### **3. จัดการรายงาน (Admin)**

```
Scenario: ตอบรายงานปัญหา

1. ไปที่ /reports
2. เห็นรายงานใหม่ "ไม่สามารถเข้าสู่ระบบได้"
3. คลิก "ดูรายละเอียด"
4. อ่านรายงาน
5. เปลี่ยนสถานะเป็น: "กำลังดำเนินการ"
6. เพิ่มบันทึก: "กำลังตรวจสอบปัญหา ขอบคุณสำหรับรายงานครับ"
7. คลิก "อัปเดตสถานะ"
8. ✅ ผู้แจ้งเห็นบันทึก!
```

### **4. ดู NotificationBanner**

```
Scenario: ผู้ใช้เห็นประกาศใหม่

1. เข้าเว็บ
2. เห็น Banner แสดงมุมบนขวา
3. อ่านประกาศ
4. คลิก [X] เพื่อ dismiss
5. ถ้า showMode = "once" → ไม่เห็นอีก
6. ถ้า showMode = "always" → Refresh แล้วเห็นอีก
```

---

## 🔥 ฟีเจอร์พิเศษ

### **1. Smart Filtering (แจ้งเตือน)**

```
ระบบกรองแจ้งเตือนอัตโนมัติ:

├─ targetType = "all"
│  ├─ แสดงให้ทุกคน
│  └─ ถ้า showMode = "once" และอ่านแล้ว → ไม่แสดง

├─ targetType = "specific"
│  ├─ แสดงเฉพาะผู้ใช้ที่กำหนด
│  └─ ถ้า showMode = "once" และอ่านแล้ว → ไม่แสดง

└─ active = false → ไม่แสดง (Admin ปิดแล้ว)
```

### **2. Real-time Preview (สร้างประกาศ)**

```
เมื่อกรอกฟอร์ม → เห็น Preview ทันที

┌─────────────────────────┐
│ 📄 ตัวอย่าง             │
│ ┌───────────────────┐   │
│ │ 🔔 แจ้งปิดปรับปรุง│   │ ← ตามที่กรอก
│ │ ระบบจะปิดปรับปรุง│   │
│ │ วันที่ 20 ต.ค...  │   │
│ └───────────────────┘   │
└─────────────────────────┘
```

### **3. Status Management (รายงานปัญหา)**

```
Workflow:

🟡 รอดำเนินการ (pending)
    ↓ Admin เริ่มดำเนินการ
🔵 กำลังดำเนินการ (in-progress)
    ↓ แก้ไขเสร็จ
🟢 แก้ไขแล้ว (resolved) ✅
    หรือ
🔴 ปฏิเสธ (rejected) ❌
```

### **4. Auto Refresh (NotificationBanner)**

```
├─ โหลดแจ้งเตือนเมื่อเข้าเว็บ
├─ Refresh ทุก 5 นาที
└─ แสดง Banner อัตโนมัติ
```

---

## 🛠️ Firestore Collections

### **1. notifications:**

```
notifications/
├─ notif-001/
│  ├─ title, message, type, showMode, targetType
│  ├─ targetUserId, targetUserEmail
│  ├─ readBy: ["user-1", "user-2"]
│  ├─ active: true
│  ├─ createdBy, createdAt, updatedAt
│  └─ ...

├─ notif-002/
│  └─ ...
```

### **2. reports:**

```
reports/
├─ report-001/
│  ├─ userId, userEmail, shopName
│  ├─ title, description
│  ├─ status, priority, category
│  ├─ adminNote, resolvedBy
│  ├─ createdAt, updatedAt, resolvedAt
│  └─ ...

├─ report-002/
│  └─ ...
```

---

## 📈 Firestore Rules

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Notifications
    match /notifications/{notificationId} {
      // ทุกคนอ่านได้
      allow read: if request.auth != null;
      
      // เฉพาะ Admin สร้าง/แก้ไข/ลบ
      allow create, update, delete: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Reports
    match /reports/{reportId} {
      // อ่าน: เฉพาะของตัวเอง หรือ Admin
      allow read: if request.auth != null && (
        resource.data.userId == request.auth.uid ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
      );
      
      // สร้าง: เฉพาะคนที่ล็อกอิน
      allow create: if request.auth != null &&
        request.resource.data.userId == request.auth.uid;
      
      // แก้ไข/ลบ: เฉพาะ Admin
      allow update, delete: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
  }
}
```

---

## ✨ สรุป

### **✅ ระบบที่สร้างเสร็จแล้ว:**

1. **ระบบแจ้งเตือน** - Admin สร้างประกาศ ผู้ใช้เห็น Banner
2. **ระบบรายงานปัญหา** - ผู้ใช้แจ้งปัญหา Admin จัดการ
3. **NotificationBanner** - แสดงอัตโนมัติ มุมบนขวา
4. **Admin Management** - จัดการทุกอย่างได้

### **📊 ข้อมูลที่แสดง:**

- ✅ แจ้งเตือนทั้งหมด (Admin) / ของตัวเอง (Seller)
- ✅ รายงานปัญหาทั้งหมด (Admin) / ของตัวเอง (Seller)
- ✅ สถิติรายงาน (Pending, In-progress, Resolved, Rejected)
- ✅ Banner แบบ Real-time

### **🔐 สิทธิ์:**

- ✅ Seller: ดูแจ้งเตือน + แจ้งปัญหา
- ✅ Admin: ทำทุกอย่างได้

---

**พร้อมใช้งานแล้ว! 🎉**

ไปที่ `/notifications` เพื่อดูแจ้งเตือนและแจ้งปัญหา  
หรือ `/reports` (Admin) เพื่อจัดการรายงานปัญหา!



